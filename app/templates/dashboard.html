<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‚Äî AlertTrail</title>
  <style>
    :root{
      --bg:#f7fafc;             /* claro */
      --panel:#ffffff;           /* tarjetas */
      --text:#0f172a;            /* slate-900 */
      --muted:#475569;           /* slate-600 */
      --line:#e5e7eb;            /* bordes */
      --brand:#2563eb;           /* azul */
      --ok:#16a34a;              /* verde */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
    .container{max-width:1100px;margin:0 auto;padding:16px}

    /* Topbar */
    .topbar{position:sticky;top:0;background:#fffccf00;backdrop-filter:saturate(1.2) blur(6px);
      border-bottom:1px solid var(--line)}
    .topbar-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:.55rem;font-weight:800;letter-spacing:.2px}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--brand);box-shadow:0 0 10px rgba(37,99,235,.6)}
    .brand a{color:var(--text);text-decoration:none}
    .pill{display:flex;align-items:center;gap:.4rem;background:#eef2ff;color:#1e3a8a;border:1px solid #dbeafe;padding:8px 10px;border-radius:999px;font-weight:600}
    .logout{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;color:#fff;background:linear-gradient(90deg,#2563eb,#16a34a);text-decoration:none}
    .logout:hover{filter:brightness(1.05)}
    .right{display:flex;align-items:center;gap:10px}

    /* Layout */
    h1{margin:18px 0 6px;font-size:1.6rem}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:16px;margin-top:16px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px}
    .card h3{margin:0 0 10px}

    /* Quick links */
    .quick{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#f8fafc;color:#0f172a;text-decoration:none}
    .chip:hover{border-color:#cbd5e1;box-shadow:0 0 0 3px #e2e8f0}

    /* Botones de acci√≥n en plan */
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .btn-primary{display:inline-block;text-decoration:none;background:var(--brand);color:#fff;border-radius:10px;padding:10px 14px;font-weight:700}
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-outline{display:inline-block;text-decoration:none;border:1px solid var(--line);border-radius:10px;padding:10px 14px;color:var(--text);background:#fff}
    .btn-outline:hover{border-color:#cbd5e1;box-shadow:0 0 0 3px #e2e8f0}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <span class="dot"></span>
        <a href="/dashboard">AlertTrail</a>
      </div>
      <div class="right">
        <span class="pill">üë§ {{ user.name }} ¬∑ Plan {{ user.plan }}</span>
        <a class="logout" href="/logout">Cerrar sesi√≥n</a>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <h1>Bienvenido, {{ user.name }}</h1>
      <p class="muted">Tu email: {{ user.email }}</p>
    </div>

    <div class="grid">
      <!-- Estado + acciones de plan -->
      <section class="card">
        <h3>Estado de tu cuenta</h3>
        <p class="muted">Plan actual: <strong>{{ user.plan }}</strong></p>
        {% if is_admin %}
          <p class="muted">Rol: <strong>Administrador</strong></p>
        {% else %}
          <p class="muted">Rol: <strong>Usuario</strong></p>
        {% endif %}
        <div class="actions">
          <a class="btn-primary" href="/billing">Cambiar plan</a>
          {# Bot√≥n de "Ver facturaci√≥n" removido #}
        </div>
      </section>

      <!-- Acceso r√°pido -->
      <section class="card">
        <h3>Acceso r√°pido</h3>
        <div class="quick">
          <a class="chip" href="/analysis">An√°lisis</a>
          <a class="chip" href="/mail">Emails</a>
          {% if is_admin %}
            <a class="chip" href="/stats">Estad√≠sticas</a>
          {% endif %}
          {# Enlace de "Facturaci√≥n" removido #}
        </div>
      </section>

      <!-- Planes -->
      <div class="card" style="margin-top:16px">
        <h3>Planes</h3>
        <div style="display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));align-items:stretch">
          <!-- PRO -->
          <div class="card" style="margin:0">
            <h3 style="margin-bottom:6px">PRO <span class="muted" style="font-weight:400">‚Äî US$ 10 / mes</span></h3>
            <ul class="muted" style="margin:8px 0 12px;padding-left:18px">
              <li>Uso individual o equipo chico</li>
              <li>Funciones completas del producto</li>
              <li>Soporte est√°ndar</li>
            </ul>
            <a class="btn-primary" href="/billing/checkout?plan=PRO">Elegir PRO</a>
          </div>
          <!-- EMPRESAS -->
          <div class="card" style="margin:0">
            <h3 style="margin-bottom:6px">EMPRESAS <span class="muted" style="font-weight:400">‚Äî US$ 99 / mes</span></h3>
            <ul class="muted" style="margin:8px 0 12px;padding-left:18px">
              <li><strong>25 asientos incluidos</strong></li>
              <li>Usuarios adicionales por asiento extra</li>
              <li>Soporte prioritario</li>
            </ul>
            <a class="btn-primary" href="/billing/checkout?plan=BIZ">Elegir EMPRESAS</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Script para notificaciones -->
  <script>
  let lastUnread = 0;

  if ("Notification" in window) {
    Notification.requestPermission().then(function (perm) {
      console.log("Permiso notificaciones:", perm);
    });
  }

  function showDesktopNotif(title, msg) {
    if ("Notification" in window && Notification.permission === "granted") {
      new Notification(title, {
        body: msg,
        icon: "/static/favicon.ico"
      });
    }
  }

  async function checkAlerts() {
    try {
      const res = await fetch("/mail/alerts/unread_count");
      if (!res.ok) return;
      const data = await res.json();
      const unread = data.unread || 0;

      if (unread > lastUnread) {
        showDesktopNotif("Nueva alerta de correo", "Se detect√≥ un correo sospechoso.");
      }
      lastUnread = unread;
    } catch (e) {
      console.error("Error chequeando alertas", e);
    }
  }

  setInterval(checkAlerts, 30000);
  checkAlerts();
  </script>
</body>
</html>
