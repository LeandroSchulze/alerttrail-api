<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard ‚Äî AlertTrail</title>
  <style>
    :root{
      --bg:#0f1115; --card:#151924; --muted:#9aa3b2; --text:#eef1f6; --accent:#5b8cff; --ok:#16a34a; --warn:#f59e0b;
      --danger:#ef4444; --border:#1f2533; --chip:#1a2130;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#5b8cff,#7c53ff)}
    .brand h1{font-size:18px;margin:0}
    .userbox{display:flex;align-items:center;gap:10px}
    .chip{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 12;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px}
    @media(min-width:880px){
      .card.span6{grid-column:span 6}
      .card.span4{grid-column:span 4}
      .card.span8{grid-column:span 8}
    }
    h2{font-size:18px;margin:0 0 8px}
    h3{font-size:16px;margin:0 0 8px}
    p{margin:6px 0;color:var(--muted)}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#1c2333;color:#eaf0ff;font-weight:600}
    .btn:hover{filter:brightness(1.08)}
    .btn-pro{background:linear-gradient(135deg,#5b8cff,#7c53ff);border-color:rgba(255,255,255,.12)}
    .btn-ghost{background:transparent}
    .btn-danger{background:#2a1620;border-color:#3a1c29;color:#ffb4c3}
    .row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .muted{color:var(--muted)}
    .list{display:grid;gap:8px}
    .kbd{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;color:#cbd5e1;background:#0d1117;border:1px solid #1f2937;border-radius:6px;padding:2px 6px}
    footer{margin:28px 0 8px;padding-top:16px;border-top:1px solid var(--border);color:var(--muted);font-size:13px}
    .notice{padding:10px 12px;border:1px dashed #324060;background:#121826;border-radius:10px}
    ul.inline{padding:0;margin:8px 0;list-style:none;display:flex;gap:12px;flex-wrap:wrap}
  </style>

  {% if user.plan in ['PRO','EMPRESAS'] %}
  <script>
    async function urlBase64ToUint8Array(base64String){
      const padding='='.repeat((4 - base64String.length % 4) % 4);
      const base64=(base64String + padding).replace(/-/g,'+').replace(/_/g,'/');
      const rawData=atob(base64); const outputArray=new Uint8Array(rawData.length);
      for(let i=0;i<rawData.length;i++) outputArray[i]=rawData.charCodeAt(i);
      return outputArray;
    }
    async function enablePush(btn){
      try{
        if(!('serviceWorker' in navigator) || !('PushManager' in window)){ alert('Este navegador no soporta Push.'); return; }
        const perm = await Notification.requestPermission();
        if(perm!=='granted'){ alert('Permiso denegado.'); return; }
        const reg = await navigator.serviceWorker.register('/static/sw.js');
        const kp  = await fetch('/push/pubkey').then(r=>r.json());
        const sub = await reg.pushManager.subscribe({
          userVisibleOnly:true,
          applicationServerKey: await urlBase64ToUint8Array(kp.vapid_public_key)
        });
        await fetch('/push/subscribe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(sub)});
        btn && (btn.textContent='‚úÖ Activadas'); alert('Notificaciones activadas');
      }catch(e){ console.error(e); alert('No se pudo activar push: '+(e?.message||e)); }
    }
    async function testPush(){
      try{
        const r = await fetch('/push/send-test',{method:'POST'});
        const d = await r.json();
        if(d?.sent){ alert('Test enviado ‚Äî mir√° la notificaci√≥n'); }
        else{ alert((d?.detail)||'No se pudo enviar'); }
      }catch(e){ alert('Error enviando test'); }
    }
  </script>
  {% endif %}
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>AlertTrail</h1>
      </div>
      <div class="userbox">
        <span class="chip">{{ user.email }}</span>
        <span class="chip">Plan: {{ user.plan }}</span>
        {% if is_admin %}<span class="chip">Admin</span>{% endif %}
      </div>
    </header>

    <div class="grid">

      <!-- Estado general -->
      <section class="card span8">
        <h2>Bienvenido, {{ user.name }}</h2>
        <p class="muted">Ac√° vas a ver el estado del sistema, tus alertas y accesos r√°pidos.</p>
        <ul class="inline">
          <li><a class="btn btn-ghost" href="/reports/">üìÑ Ver reportes (PDF)</a></li>
          <li><a class="btn btn-ghost" href="/push/test-page">üîî Probar notificaciones</a></li>
          <li><a class="btn btn-ghost" href="/docs">üìö API Docs</a></li>
        </ul>
        <div class="notice" style="margin-top:10px">
          <strong>Tip:</strong> Si activ√°s las notificaciones Push, vas a recibir avisos cuando detectemos
          adjuntos maliciosos o intentos de phishing. Funciona en PRO y EMPRESAS.
        </div>
      </section>

      <!-- Acciones de plan / upgrade -->
      {% if user.plan not in ['PRO','EMPRESAS'] %}
      <section class="card span4">
        <h3>Mejora a PRO</h3>
        <p>Funciones avanzadas, notificaciones en tiempo real y m√°s.</p>
        <div class="row">
          <a class="btn btn-pro" href="/billing/checkout">üöÄ Hazte PRO</a>
        </div>
        <hr style="border-color:var(--border);margin:14px 0">
        <h3>Plan Empresas</h3>
        <p class="muted">USD 99/mes ‚Äî incluye 25 cuentas (extras opcionales).</p>
        <div class="row">
          <a class="btn" href="/billing/checkout/empresas">üè¢ Contratar EMPRESAS</a>
        </div>
      </section>
      {% else %}
      <!-- Bloque de notificaciones solo para PRO/EMPRESAS -->
      <section class="card span4">
        <h3>Notificaciones Push</h3>
        <p>Recib√≠ alertas en tu equipo cuando detectemos un correo sospechoso.</p>
        <div class="row">
          <button class="btn" onclick="enablePush(this)">üîî Activar notificaciones</button>
          <button class="btn" onclick="testPush()">‚ñ∂ Probar env√≠o</button>
        </div>
        <p class="muted" style="margin-top:8px">Si no ves la notificaci√≥n, verific√° permiso del navegador y que <span class="kbd">/static/sw.js</span> est√© accesible.</p>
      </section>
      {% endif %}

      <!-- Accesos r√°pidos a correo / alertas -->
      <section class="card span6">
        <h3>Correo & Alertas</h3>
        <p>El esc√°ner de correo marca adjuntos maliciosos y posibles phishing.</p>
        <ul class="inline">
          <li><a class="btn" href="/mail/alerts">üì® Ver alertas de mail</a></li>
          <li><a class="btn" href="/push/test-page">üîî Activar/Probar push</a></li>
        </ul>
        <p class="muted">Cuando llegue un mail con objeto malicioso, ver√°s una alerta y (si habilitaste) te llegar√° una notificaci√≥n.</p>
      </section>

      <!-- Anal√≠tica / PDFs -->
      <section class="card span6">
        <h3>An√°lisis & Reportes</h3>
        <p>Gener√° reportes PDF desde el an√°lisis de eventos.</p>
        <ul class="inline">
          <li><a class="btn" href="/analysis">üß™ Ir al an√°lisis</a></li>
          <li><a class="btn" href="/reports/">üìÑ Descargar √∫ltimos PDFs</a></li>
        </ul>
        <p class="muted">Si tu an√°lisis soporta <span class="kbd">?as_pdf=1</span>, pod√©s descargar directamente el informe.</p>
      </section>

      {% if is_admin %}
      <section class="card span12">
        <h3>Administraci√≥n</h3>
        <ul class="inline">
          <li><a class="btn" href="/stats">üìä Estad√≠sticas</a></li>
          <li><a class="btn btn-danger" href="/admin/tasks">üõ†Ô∏è Tareas</a></li>
        </ul>
        <p class="muted">Solo visible para administradores.</p>
      </section>
      {% endif %}

    </div>

    <footer>
      &copy; 2025 AlertTrail ¬∑
      <a href="mailto:supp.alerttrail@gmail.com">Soporte: supp.alerttrail@gmail.com</a>
    </footer>
  </div>
</body>
</html>
