<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>AlertTrail — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <link rel="icon" href="/static/favicon.ico">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body {
      margin: 0;
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: #eaf2f7;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(0,140,200,.20), transparent),
                  radial-gradient(900px 500px at 120% 10%, rgba(0,160,220,.15), transparent),
                  #0b1620;
      min-height: 100vh;
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 28px 16px 64px; }
    .topbar { display:flex; align-items:center; gap:12px; }
    .brand { font-weight:700; font-size: 22px; }
    .badge { font-size: 12px; padding: 2px 8px; border-radius: 999px; background: #0ea5e9; color:#03131c; font-weight: 700;}
    nav a { color:#7dd3fc; text-decoration:none; margin-left: 20px; }
    nav a:hover { text-decoration: underline; }

    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 18px 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
      backdrop-filter: blur(4px);
    }
    .grid { display:grid; gap:16px; }
    .grid.cols-2 { grid-template-columns: 1.2fr .8fr; }
    .muted { color:#bfe6fb; opacity:.8; }
    .btn {
      display:inline-block; padding:10px 14px; border-radius:10px;
      background:#0ea5e9; color:#03131c; font-weight:700; text-decoration:none;
    }
    .btn:hover { filter: brightness(.95); }
    ul { margin:6px 0 0 18px; }
    footer { margin-top: 32px; text-align:center; color:#8bd2f7; opacity:.7; }
    .stats { display:grid; grid-template-columns: repeat(3,1fr); gap:12px; margin-top:8px;}
    .stat { background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:14px; text-align:center;}
    .stat h3 { margin:0; font-size:28px;}
    .stat p { margin:2px 0 0; font-size:12px; opacity:.85;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">☰&nbsp; AlertTrail</div>
      {% if current_user and (current_user.plan or '')|upper == 'PRO' %}
        <span class="badge">PRO</span>
      {% endif %}
      <nav style="margin-left:auto">
        <a href="/analysis/generate">Generar PDF</a>
        <a href="/mail/connect">Conectar mail</a>
        <a href="/mail/scanner">Scanner de mail</a>
        <a href="/auth/logout">Salir</a>
      </nav>
    </div>

    <div class="grid cols-2" style="margin-top:18px">
      <section class="card">
        <p class="muted">Bienvenido/a</p>
        <h2 style="margin:2px 0 6px">{{ (current_user.name or 'Usuario') if current_user else 'Usuario' }}</h2>
        <p class="muted">{{ (current_user.email or '') if current_user else '' }}</p>
        <p class="muted" style="margin-top:6px">Estado: <strong>{{ ((current_user.plan or "FREE") if current_user else "FREE")|upper }}</strong></p>
      </section>

      <section class="card">
        <h3 style="margin:0 0 8px">Acciones rápidas</h3>
        <ul>
          <li><a class="btn" href="/analysis/generate">Analizar logs y generar PDF</a></li>
          <li style="margin-top:8px"><a class="btn" href="/mail/connect">Vincular una casilla de correo</a></li>
          <li style="margin-top:8px"><a class="btn" href="/mail/scanner">Ejecutar scanner de mail</a></li>
        </ul>
      </section>
    </div>

    {% if is_admin %}
      <section class="card" style="margin-top:16px">
        <div style="display:flex; align-items:center; justify-content:space-between">
          <h3 style="margin:0">Métricas (solo admin)</h3>
          <button id="refresh" class="btn" type="button">Actualizar</button>
        </div>
        <div class="stats" id="stats">
          <div class="stat"><h3>—</h3><p>PDFs este mes</p></div>
          <div class="stat"><h3>—</h3><p>Usuarios Free</p></div>
          <div class="stat"><h3>—</h3><p>Usuarios PRO</p></div>
        </div>
        <p id="range" class="muted" style="margin-top:8px"></p>
      </section>
      <script>
        async function loadStats(){
          try{
            const r = await fetch('/stats', { credentials:'include' });
            if(!r.ok) throw new Error('HTTP '+r.status);
            const data = await r.json();
            const boxes = document.querySelectorAll('#stats .stat h3');
            boxes[0].textContent = data.pdfs_mes ?? '0';
            boxes[1].textContent = data.usuarios_free ?? '0';
            boxes[2].textContent = data.usuarios_pro ?? '0';
            document.getElementById('range').textContent =
              `Rango: ${data.desde?.slice(0,10)} → ${data.hasta?.slice(0,10)}`;
          }catch(e){ console.error(e); }
        }
        document.getElementById('refresh')?.addEventListener('click', loadStats);
        loadStats();
      </script>
    {% endif %}

    <footer>© AlertTrail</footer>
  </div>
</body>
</html>
